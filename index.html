<script type="module">
  import yaml from 'https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/+esm';

  const yamlText = `
books:
  - title: "Sapiens"
    author: "Yuval Noah Harari"
    rating: 4.5
    pages: 412
    color: "#f4c542"
    favorite: true

  - title: "Atomic Habits"
    author: "James Clear"
    rating: 5.0
    pages: 320
    color: "#3399ff"
    favorite: false

  - title: "Deep Work"
    author: "Cal Newport"
    rating: 4.0
    pages: 296
    color: "#cc6666"
    favorite: true
  `;

  const data = yaml.load(yamlText).books;

  const svg = d3.select("#bookshelf");
  const tooltip = d3.select(".tooltip");
  const shelfHeight = 100;
  const shelfPadding = 10;
  const bookSpacing = 4;
  const shelfCount = 5;

  for (let i = 0; i < shelfCount; i++) {
    svg.append("rect")
      .attr("x", 0)
      .attr("y", i * shelfHeight)
      .attr("width", 1000)
      .attr("height", 10)
      .attr("class", "shelf");
  }

  let xOffset = 10;
  let shelfIndex = 0;

  data.forEach((book, i) => {
    const height = 50 + (book.pages / 10);
    const width = 18;
    if (xOffset + width > 980) {
      xOffset = 10;
      shelfIndex++;
    }

    const y = shelfIndex * shelfHeight + (shelfHeight - height - 10);

    const group = svg.append("g");

    group.append("rect")
      .attr("x", xOffset)
      .attr("y", y)
      .attr("width", width)
      .attr("height", height)
      .attr("fill", book.color)
      .attr("class", "book")
      .on("mouseover", (event) => {
        tooltip
          .style("left", event.pageX + 10 + "px")
          .style("top", event.pageY + "px")
          .style("display", "block")
          .html(`<strong>${book.title}</strong><br>${book.author}<br>${book.pages} Seiten<br>★ ${book.rating}`);
      })
      .on("mouseout", () => tooltip.style("display", "none"));

    if (book.favorite) {
      group.append("text")
        .attr("x", xOffset + width / 2)
        .attr("y", y - 5)
        .attr("text-anchor", "middle")
        .attr("class", "star")
        .text("★");
    }

    xOffset += width + bookSpacing;
  });
</script>
